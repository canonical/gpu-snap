#!/bin/bash
set -euo pipefail

SELF="$( cd -- "$(dirname "$0")/.." ; pwd -P )"

TMP_FOLDER=$(mktemp -d)

(
  for provider in "$@"; do
    snap download --target-directory ${TMP_FOLDER}/ --basename ${provider} ${provider}
    unsquashfs -cat ${TMP_FOLDER}/${provider}.snap snap/${CRAFT_TARGET_ARCH}.list \
             > ${TMP_FOLDER}/original-list.txt
    # If the lists are different, cmp will fail and thus the script too.
    # This ensures that if the upstream snap and this one aren't in sync,
    # the build will be aborted
    cmp ${TMP_FOLDER}/original-list.txt ${SELF}/lists/${provider}.${CRAFT_TARGET_ARCH}.list
    rm -rf ${TMP_FOLDER}/*
  done
)

rm -rf ${TMP_FOLDER}

rm -f $(
  (
    for provider in "$@"; do
      cat ${SELF}/lists/$provider.${CRAFT_TARGET_ARCH}.list
    done
  ) | sort -u | awk "/.+/ { print \"${CRAFT_PRIME}/\" \$0 }"
)

find "${CRAFT_PRIME}" -type d -empty -delete
